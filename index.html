<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¸èª²å ‚è¡¨ç¾ç´€éŒ„ç³»çµ± v2.0</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f8f9fa;
        }

        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--accent-color);
            border-bottom: 3px solid var(--accent-color);
        }

        .tab-btn:hover { background-color: #f1f1f1; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #eee;
            padding: 10px;
            border-radius: 5px;
        }

        input[type="date"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        button.action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            margin-right: 5px;
            transition: opacity 0.2s;
        }

        button.action-btn:hover { opacity: 0.9; }
        button.action-btn:active { transform: scale(0.98); }

        .btn-part { background-color: var(--success-color); }
        .btn-q { background-color: var(--accent-color); }
        .btn-c { background-color: var(--warning-color); }
        .btn-r { background-color: var(--danger-color); }
        .btn-export { background-color: #2c3e50; float: right;}
        .btn-clear { background-color: #7f8c8d; }
        .btn-delete { background-color: #c0392b; font-size: 0.8em; padding: 5px 10px;}

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:hover { background-color: #f1f1f1; }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .btn-confirm { background-color: var(--success-color); color: white; padding: 10px 20px; border:none; border-radius: 4px; cursor: pointer; font-size: 16px;}
        .btn-cancel { background-color: #95a5a6; color: white; padding: 10px 20px; border:none; border-radius: 4px; cursor: pointer; font-size: 16px;}

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 101;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

<div class="container">
    <h1>èª²å ‚ç´€éŒ„èˆ‡çµ±è¨ˆç³»çµ± v2.0</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('record')">ğŸ“ èª²å ‚ç´€éŒ„ (Record)</button>
        <button class="tab-btn" onclick="switchTab('history')">ğŸ“œ æ­·å²èˆ‡ä¿®æ”¹ (History)</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š çµ±è¨ˆæ•¸æ“š (Stats)</button>
        <button class="tab-btn" onclick="switchTab('settings')" style="margin-left: auto;">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="record-panel" class="panel active">
        <div class="controls">
            <div>
                <label for="recordDate"><strong>ç´€éŒ„æ—¥æœŸï¼š</strong></label>
                <input type="date" id="recordDate">
            </div>
            <span style="font-size: 0.9em; color: #666;">é»æ“Šå¾Œéœ€ç¢ºèªæ‰æœƒå„²å­˜</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 15%">å­¸è™Ÿ</th>
                    <th style="width: 20%">å§“å</th>
                    <th style="width: 25%">èª²å ‚è¡¨ç¾</th>
                    <th style="width: 40%">é ç¿’åŠŸèª² (Outstanding Pre-lesson)</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                </tbody>
        </table>
    </div>

    <div id="history-panel" class="panel">
        <div class="controls">
            <h3>æ­·å²ç´€éŒ„ä¸€è¦½ (æŒ‰æ™‚é–“æ’åº)</h3>
            <span style="font-size:0.9em; color: #666;">è‹¥ç´€éŒ„éŒ¯èª¤ï¼Œè«‹é»æ“Šå³å´ã€Œåˆªé™¤ã€æŒ‰éˆ•</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th>ç¯„ç–‡</th>
                    <th>ç´°é …</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                </tbody>
        </table>
    </div>

    <div id="stats-panel" class="panel">
        <div class="controls">
            <h3>ç¸½è¨ˆä¸€è¦½è¡¨</h3>
            <button class="action-btn btn-export" onclick="exportCSV()">ğŸ“¥ ä¸‹è¼‰ CSV å ±è¡¨</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>å­¸è™Ÿ</th>
                    <th>å§“å</th>
                    <th onclick="sortTable(2)" style="cursor:pointer">èª²å ‚è¡¨ç¾ (æ¬¡æ•¸) â†•</th>
                    <th onclick="sortTable(3)" style="cursor:pointer">Pre-Task: Q â†•</th>
                    <th onclick="sortTable(4)" style="cursor:pointer">Pre-Task: C â†•</th>
                    <th onclick="sortTable(5)" style="cursor:pointer">Pre-Task: R â†•</th>
                    <th onclick="sortTable(6)" style="cursor:pointer">ç¸½è¨ˆæ¬¡æ•¸ â†•</th>
                </tr>
            </thead>
            <tbody id="statsTableBody">
                </tbody>
        </table>
    </div>

    <div id="settings-panel" class="panel">
        <h3>å­¸ç”Ÿåå–®ç®¡ç†</h3>
        <p>è«‹è¼¸å…¥å­¸ç”Ÿåå–® (æ ¼å¼ï¼šå­¸è™Ÿ,å§“å)ï¼Œæ¯è¡Œä¸€ä½å­¸ç”Ÿã€‚</p>
        <textarea id="studentInput" rows="10" style="width: 100%; padding: 10px; border:1px solid #ccc;">
1001,é™³å¤§æ–‡
1002,æå°æ˜
1003,å¼µå¿—å¼·
1004,ç‹ç¾ç²
1005,ä½•åœ‹æ¦®
</textarea>
        <br><br>
        <button class="action-btn btn-q" onclick="saveStudentList()">æ›´æ–°å­¸ç”Ÿåå–®</button>
        <hr>
        <h3>è³‡æ–™ç¶­è­·</h3>
        <button class="action-btn btn-clear" onclick="clearAllData()">âš ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0;">ç¢ºèªç´€éŒ„</h2>
        <p style="font-size: 1.1em; line-height: 1.6;">
            å­¸ç”Ÿï¼š<strong id="modal-student-name" style="color:var(--primary-color)"></strong><br>
            ç¯„ç–‡ï¼š<span id="modal-category"></span><br>
            ç´°é …ï¼š<strong id="modal-type" style="color:var(--accent-color)"></strong><br>
            æ—¥æœŸï¼š<span id="modal-date"></span>
        </p>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ (Esc)</button>
            <button class="btn-confirm" onclick="confirmAddRecord()" id="btn-confirm-final">ç¢ºèªè¼¸å…¥ (Enter)</button>
        </div>
    </div>
</div>

<div id="toast">ç´€éŒ„å·²æ›´æ–°ï¼</div>

<script>
    // --- Initial Data & State ---
    let students = [];
    let records = [];
    
    // Staging data for the modal
    let pendingRecord = null;

    window.onload = function() {
        document.getElementById('recordDate').valueAsDate = new Date();
        loadData();
        renderRecordingTable();
        
        // Add keyboard listener for modal
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('confirmModal');
            if (modal.style.display === "block") {
                if (event.key === "Enter") {
                    confirmAddRecord();
                } else if (event.key === "Escape") {
                    closeModal();
                }
            }
        });
    };

    // --- Core Functions ---
    function loadData() {
        const storedStudents = localStorage.getItem('uni_tracker_students');
        if (storedStudents) {
            students = JSON.parse(storedStudents);
            let textList = students.map(s => `${s.id},${s.name}`).join('\n');
            document.getElementById('studentInput').value = textList;
        } else {
            saveStudentList(false); 
        }

        const storedRecords = localStorage.getItem('uni_tracker_records');
        if (storedRecords) {
            records = JSON.parse(storedRecords);
        }
    }

    function saveStudentList(showAlert = true) {
        const input = document.getElementById('studentInput').value;
        const lines = input.split('\n');
        const newStudents = [];
        lines.forEach(line => {
            if(line.trim() !== "") {
                const parts = line.split(',');
                if(parts.length >= 2) {
                    newStudents.push({ id: parts[0].trim(), name: parts[1].trim() });
                }
            }
        });
        students = newStudents;
        localStorage.setItem('uni_tracker_students', JSON.stringify(students));
        if(showAlert) {
            alert('å­¸ç”Ÿåå–®å·²æ›´æ–°ï¼');
            renderRecordingTable();
        }
    }

    // --- New Workflow: Open Modal -> Confirm -> Save ---
    
    function openConfirmModal(studentId, category, type) {
        const date = document.getElementById('recordDate').value;
        if (!date) { alert("è«‹é¸æ“‡æ—¥æœŸï¼"); return; }
        
        const student = students.find(s => s.id === studentId);
        
        // Store pending data
        pendingRecord = {
            id: Date.now(),
            studentId: studentId,
            studentName: student.name, // caching name for ease
            date: date,
            category: category,
            type: type
        };

        // UI Update
        document.getElementById('modal-student-name').innerText = student.name + " (" + student.id + ")";
        document.getElementById('modal-category').innerText = category === 'Participation' ? 'èª²å ‚è¡¨ç¾' : 'é ç¿’åŠŸèª² (Pre-Task)';
        document.getElementById('modal-type').innerText = type === 'Correct' ? 'å›ç­”æ­£ç¢º' : type;
        document.getElementById('modal-date').innerText = date;

        document.getElementById('confirmModal').style.display = "block";
        document.getElementById('btn-confirm-final').focus(); // Auto focus on confirm button
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = "none";
        pendingRecord = null;
    }

    function confirmAddRecord() {
        if (!pendingRecord) return;

        records.push(pendingRecord);
        localStorage.setItem('uni_tracker_records', JSON.stringify(records));
        
        showToast(`âœ… å·²ç´€éŒ„ï¼š${pendingRecord.studentName} - ${pendingRecord.type}`);
        closeModal();
    }

    function deleteRecord(recordId) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ")) {
            records = records.filter(r => r.id !== recordId);
            localStorage.setItem('uni_tracker_records', JSON.stringify(records));
            renderHistoryTable(); // Refresh history view
            showToast("ğŸ—‘ï¸ ç´€éŒ„å·²åˆªé™¤");
        }
    }

    // --- Rendering ---
    function renderRecordingTable() {
        const tbody = document.getElementById('studentTableBody');
        tbody.innerHTML = '';
        students.forEach(student => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${student.id}</td>
                <td><strong>${student.name}</strong></td>
                <td><button class="action-btn btn-part" onclick="openConfirmModal('${student.id}', 'Participation', 'Correct')">âœ… å›ç­”æ­£ç¢º</button></td>
                <td>
                    <button class="action-btn btn-q" onclick="openConfirmModal('${student.id}', 'PreTask', 'Q')">Q</button>
                    <button class="action-btn btn-c" onclick="openConfirmModal('${student.id}', 'PreTask', 'C')">C</button>
                    <button class="action-btn btn-r" onclick="openConfirmModal('${student.id}', 'PreTask', 'R')">R</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderStatsTable() {
        const tbody = document.getElementById('statsTableBody');
        tbody.innerHTML = '';
        const stats = students.map(student => {
            const studentRecords = records.filter(r => r.studentId === student.id);
            return {
                id: student.id,
                name: student.name,
                part: studentRecords.filter(r => r.category === 'Participation').length,
                q: studentRecords.filter(r => r.type === 'Q').length,
                c: studentRecords.filter(r => r.type === 'C').length,
                r: studentRecords.filter(r => r.type === 'R').length,
                total: studentRecords.length
            };
        });
        stats.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.id}</td><td>${s.name}</td><td>${s.part}</td><td>${s.q}</td><td>${s.c}</td><td>${s.r}</td><td><strong>${s.total}</strong></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderHistoryTable() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        
        // Clone and sort records (Newest first)
        const sortedRecords = [...records].sort((a, b) => b.id - a.id);

        if (sortedRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰ç´€éŒ„</td></tr>';
            return;
        }

        sortedRecords.forEach(r => {
            // Find current name in case student list changed, fallback to stored name if available, else ID
            const student = students.find(s => s.id === r.studentId);
            const name = student ? student.name : (r.studentName || r.studentId);
            
            const tr = document.createElement('tr');
            const catDisplay = r.category === 'Participation' ? 'èª²å ‚è¡¨ç¾' : 'é ç¿’åŠŸèª²';
            
            tr.innerHTML = `
                <td>${r.date}</td>
                <td>${r.studentId}</td>
                <td>${name}</td>
                <td>${catDisplay}</td>
                <td><span class="badge">${r.type}</span></td>
                <td><button class="action-btn btn-delete" onclick="deleteRecord(${r.id})">ğŸ—‘ï¸ åˆªé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Utilities ---
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
        
        if (tabName === 'record') document.getElementById('record-panel').classList.add('active');
        else if (tabName === 'history') {
            document.getElementById('history-panel').classList.add('active');
            renderHistoryTable();
        }
        else if (tabName === 'stats') {
            document.getElementById('stats-panel').classList.add('active');
            renderStatsTable();
        }
        else document.getElementById('settings-panel').classList.add('active');
    }

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function exportCSV() {
        const csvRows = [];
        csvRows.push(['Student ID', 'Name', 'Class Participation', 'Pre-Task Q', 'Pre-Task C', 'Pre-Task R', 'Total']);
        students.forEach(student => {
            const studentRecords = records.filter(r => r.studentId === student.id);
            const part = studentRecords.filter(r => r.category === 'Participation').length;
            const q = studentRecords.filter(r => r.type === 'Q').length;
            const c = studentRecords.filter(r => r.type === 'C').length;
            const r = studentRecords.filter(r => r.type === 'R').length;
            csvRows.push([student.id, student.name, part, q, c, r, studentRecords.length]);
        });
        const csvContent = "\uFEFF" + csvRows.map(e => e.join(",")).join("\n");
        const link = document.createElement("a");
        link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent);
        link.download = "class_performance_stats.csv";
        document.body.appendChild(link);
        link.click();
    }

    function clearAllData() {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚")) {
            records = [];
            localStorage.setItem('uni_tracker_records', JSON.stringify(records));
            alert("ç´€éŒ„å·²æ¸…é™¤ã€‚");
            renderStatsTable();
            renderHistoryTable();
        }
    }

    function sortTable(n) {
      var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      table = document.querySelector("#stats-panel table");
      switching = true;
      dir = "asc"; 
      while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName("TD")[n];
          y = rows[i + 1].getElementsByTagName("TD")[n];
          let xVal = isNaN(parseInt(x.innerHTML)) ? x.innerHTML.toLowerCase() : parseInt(x.innerHTML);
          let yVal = isNaN(parseInt(y.innerHTML)) ? y.innerHTML.toLowerCase() : parseInt(y.innerHTML);
          if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } } 
          else if (dir == "desc") { if (xVal < yVal) { shouldSwitch = true; break; } }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount ++;      
        } else {
          if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
        }
      }
    }
</script>

</body>
</html>